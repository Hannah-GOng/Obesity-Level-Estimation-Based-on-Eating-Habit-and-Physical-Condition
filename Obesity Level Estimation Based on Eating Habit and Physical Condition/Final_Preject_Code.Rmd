---
title: "Proportional Odds Model On Estimation Obesity Level Based On Eating Habits and Physical Conditions"
author: "Han Gong"
date: "11/11/2020"
output:
  pdf_document: default
  html_document: default
  word_document: default
---
# Introduction

The obesity epidemic has become one of the most serious public health problems globally. Obesity and overweight are described as "excessive fat accumulation in certain body areas that can be harmful to health" by the World Health Organization(WHO) [1]. According to the research conducted by WHO in 2014, over 1900 million obese adults worldwide, which is double times compared to the number in 1980[1]. Previous research has shown that various social and behavioral factors can explain this rapid growth. Among them, unhealthy eating habits and lifestyle are two crucial risk factors for the development of obesity[3]. As the pandemic of COVID-19 enforced the practice of social-distancing and remote working, the altered eating behaviors and physical conditions such as longer screen time, intake of high caloric food, and reduced activity frequency may contribute to a higher risk of obesity. This analysis is aimed to conduct a statical analysis based on previous study data on obesity, using exploratory data analysis and model fitting to access whether and to what extend behaviors or physical conditions discussed in the study have a significant impact on causing and predicting obesity. 

```{r message = FALSE, echo= FALSE}
library(ggplot2)
library(MASS)
library(caret)
library(dplyr)
library(car)
library(arm)
library(pROC)
library(e1071)
library(nnet)
library(knitr)
library(pander)
```

```{r, echo = FALSE}
obesity <- read.csv('ObesityDataSet_raw_and_data_sinthetic.csv',
                   col.names = c('Gender', "Age", "Height","Weight","Family_History",
                                 "High_Caloric_Food","Vegetable","Main_Meals","Between_Meals",
                                 "SMOKE","Water","Monitoring","Physical_Activity","Time_On_Technology_Devices","Alcohol",
                                 "Transportation","Obesity"))

```

# Data Preprocessing
The dataset used in this statistical analysis is accessed via the UCI machine learning public database and collected by a 2018 study on obesity levels estimation based on anonymous survey results collected among individuals from Colombia, Peru, and Mexico [2]. The original data is comprised of 2111 non-empty and 17 variables, including demographic information, eating habits, and physical conditions. For this analysis, individuals' obesity levels were calculated by the BMI function and categorized using the WHO standard for overweight and obesity (BMI = Weight / (Height^2)) [2]. The target response in the final dataset is a naturally ordered categorical value, containing three levels of body condition – 'normal and underweight', 'overweight' and 'obesity.' Categorical variables obtained from the survey that measured behavior frequency, such as frequency of smoking and alcohol consumption, are converted to dummy variables with level "yes" and "no."

```{r Data Preprocessing, echo = FALSE, message = FALSE, warning = FALSE}
# Categorical variables: gender, family history of obesity, frequent consumption of high caloric food, Food Consumption Between Meals, Smoke, Calories consumption monitoring, Consumption of alcohol,Transportation used

obesity$Gender <- as.factor(obesity$Gender)
obesity$Family_History <- as.factor(obesity$Family_History)
obesity$High_Caloric_Food <- as.factor(obesity$High_Caloric_Food) # frequent consumption of high caloric food
obesity$Between_Meals <- as.factor(obesity$Between_Meals)
obesity$SMOKE <- as.factor(obesity$SMOKE)
obesity$Monitoring <- as.factor(obesity$Monitoring)
obesity$Alcohol <- as.factor(obesity$Alcohol)
obesity$Transportation <- as.factor(obesity$Transportation)

# Response variables
obesity$Obesity <- as.factor(obesity$Obesity)

# Add BMI for EDA
obesity <- obesity %>% mutate( bmi = Weight / Height^2)

# Combine Levels for Alcohol Consumption, between_meals
obesity <- obesity %>% mutate(
        Alcohol = case_when(
                Alcohol == "Sometimes" ~ 'Yes',
                Alcohol == "Frequently" ~ 'Yes',
                Alcohol == "Always" ~ 'Yes',
                Alcohol == "no" ~ 'No'))

obesity = obesity %>% mutate(
        Between_Meals = case_when(
                Between_Meals == "Sometimes" ~ 'Yes',
                Between_Meals == "Frequently" ~ 'Yes',
                Between_Meals == "Always" ~ 'Yes',
                Between_Meals == "no" ~ 'No'))

# Combine Levels for obesity
obesity = obesity %>% mutate(
        obesity_new = case_when(
                Obesity == "Insufficient_Weight" ~ 'Normal_or_Underweight',
                Obesity == "Normal_Weight" ~ "Normal_or_Underweight",
                Obesity == "Overweight_Level_I" ~ "Overweight",
                Obesity == "Overweight_Level_II" ~"Overweight",
                Obesity == "Obesity_Type_I"~"Obesity",
                Obesity == "Obesity_Type_II"~"Obesity",
                Obesity == "Obesity_Type_III"~"Obesity"))

# Ordered Level
obesity$obesity_ordered <- ordered(obesity$obesity_new,
                           levels=c("Normal_or_Underweight","Overweight",
                                    "Obesity"))
```

# Exploratory Data Analysis

After data cleaning and preprocessing, the data displays that the overall probability of becoming overweight is approximately 27.5% for the entire population surveyed, while the likelihood of reaching obesity measurement is 46%. It is important to remark that the number of individuals in each category is normalized to avoid skewed learning towards the majority class. Therefore, the baseline probability of becoming overweight and obese will only use as a benchmark in the exploratory data analysis but not reveal accurate stats of the population structure. In the process, summary statistics are presented by tables and plots to demonstrate the differences in participant's probabilities of categorizing as overweight and obese, given their demographic information, eating habits, and physical conditions recorded. 

```{r Response variable, echo = FALSE, include = FALSE}
# Response variable
table(obesity$obesity_ordered)
p = ggplot(obesity, aes(x=obesity_ordered)) +
  geom_bar()
p + theme(axis.text.x = element_text(angle = 90)) + labs(title = 'Obesity Level Distribution')
```

Figure 1 identifies the relationship between obesity levels and age for participants, indicating a potential linear association between age and obesity level. Compared to the normal and overweight category, the increase in the average population age in the obesity category explains obesity as an age-related disease. The increasing risk that corresponds to aging may be explained by hormonal changes, decreases in metabolism, and a less active lifestyle. However, as the dataset's surveyed population is highly skewed towards teenagers and university students, the significance of aging in obesity development needs to be examined in the final model. Besides aging, family obesity history is another demographic variable that contributes to greater possibilities of obesity. Table 1, 2, and 3 demonstrates the conditional probability of overweight and obese, given whether individuals have family members suffering from exceeded body weights. In the overall sample population, the chance of overweight and obese people with family obesity records is three times higher than those without such histories. Although family history is a notable risk factor in both female and male populations, females have significantly higher rates of obesity if their family members experience obesity. In comparison, males have higher rates of overweight in the same condition. Therefore, females with family histories of obesity faced more challenges in controlling weight and overcoming obesity, given their biologically higher body fat percentage. 


```{r, echo = FALSE, message = FALSE, warning = FALSE}
# The possibility of getting obesity increases as the age increases
p1 = ggplot(data = obesity, aes(x=obesity_ordered, y=Age, fill = obesity_ordered)) + 
  geom_boxplot(alpha=0.2)  
p1 + labs(title = "Figure1: Association between age and obesity level", 
          caption = "Data from Obesity level estimation on eating habit and physical condition, 2018 [2]")+
theme(
plot.title = element_text(size=11, face="bold"), legend.position="none", axis.title.x = element_blank(), )
```


```{r, echo = FALSE,message = FALSE, warning = FALSE}
pander(prop.table(table(obesity$obesity_ordered, obesity$Family_History), 2), caption = "Conditional probability of obesity levels, Data from Obesity level estimation on eating habit and physical condition, 2018 [2]")
men = obesity[obesity$Gender == 'Male',]
female = obesity[obesity$Gender == 'Female',]
pander(prop.table(table(men$obesity_ordered, men$Family_History), 2), caption = "Conditional probability of obesity levels among females, based on family history of obesity, Data from Obesity level estimation on eating habit and physical condition, 2018 [2]")
pander(prop.table(table(female$obesity_ordered, female$Family_History), 2), caption = "Conditional probability of obesity levels among males, based on family history of obesity, Data from Obesity level estimation on eating habit and physical condition, 2018 [2]")
pander(prop.table(table(men$obesity_ordered, men$Alcohol), 2), caption = "Conditional probability of obesity levels among females, based on drinking behavior, Data from Obesity level estimation on eating habit and physical condition, 2018 [2]")
pander(prop.table(table(female$obesity_ordered, female$Alcohol), 2), caption = "Conditional probability of obesity levels among males, based on drinking behavior, Data from Obesity level estimation on eating habit and physical condition, 2018 [2]")
```

Controlling for risk factors in the demographic groups, eating habits such as intake of energy-dense food, meal food consumption, and alcohol drinking behaviors are risk factors that will increase the risk of obesity. While the effect of the previous two behaviors appears to be the same regardless of demographic groups, there’s an interaction effect between alcohol consumption and gender, indicating that females are more easily influenced by alcohol consumption in terms of obesity risk. Table 4 and 5 show the difference in obesity and overweight probability among females and males, given whether individuals have alcohol consumption behavior. For females with drinking habits, the likelihood of having exceeded body weight increases from 57% to 74%, with the almost doubled possibility of reaching obesity level, compared to those who claimed no alcohol consumption. In contrast, regardless of the increased likelihood of exceeding the WHO standard for normal BMI, the overall possibility of receiving obesity measures remains unchanged. Therefore, compared to males, females should take alcohol consumption more seriously when controlling for exceeded body weight.


When exploring the association between obesity and physical conditions such as transportation methods and physical exercise, the statistic testing result shows a strong correlation between longer physical exercise time, green transportation methods, and avoiding obesity. However, figure 2 illustrates a slightly negative association between screening time and obesity risks. On average, people in the normal category spent the most time on technological devices such as computers and cell phones. Considering the sample size and the scale of difference, this negative association can be insignificant. It may result from confounding variables such as age since adolescents usually spend more time online. This hypothesis can be confirmed by the strong linear correlation between age and time spent on technology devices presented in figure 3. As shown in the figure, screen time can be linearly predicted from age with a substantial degree of accuracy, indicating screen time alone does not directly impact obesity levels. Further tests on multicollinearity, model evaluation method to avoid strong association between two predictors in a multiple regression model, can be conducted in the model fitting process to determine whether the screen time is an independent risk predictor.

```{r, echo= FALSE,message = FALSE, warning = FALSE}
# No significant trend
p2 = ggplot(data = obesity, aes(x=obesity_ordered, y=Time_On_Technology_Devices, fill = obesity_ordered)) + 
  geom_boxplot(alpha=0.2)  +  theme(legend.position="none")
p2 + labs(title = "Figure2: Association between time on technology devices and obesity level", 
          caption = "Data from Obesity level estimation on eating habit and physical condition, 2018 [2]")+
theme(
  plot.title = element_text(size=11, face="bold"), legend.position="none", axis.title.x = element_blank())
```


```{r, echo = FALSE,message = FALSE, warning = FALSE}
p3 = ggplot(data = obesity, aes(x=Age, y=Time_On_Technology_Devices, color = obesity_ordered)) + 
  geom_point(alpha=0.2) + geom_smooth(method = 'lm')
p3 + labs(title = "Figure3: Association between time on technology devices and age", 
          caption = "Data from Obesity level estimation on eating habit and physical condition, 2018 [2]")+
theme(
  plot.title = element_text(size=11, face="bold"))
```

```{r numeric Varible, echo = FALSE, include=FALSE}
# Convert to Categorical Variable?
ggplot(data = obesity, aes(x=obesity_ordered, y=Vegetable)) + 
  geom_boxplot(alpha=0.2)  +  theme(legend.position="none")

# Convert to Categorical Variable? Association not casual effect
ggplot(data = obesity, aes(x=Main_Meals, y=obesity_ordered)) + 
  geom_boxplot(alpha=0.2)  +  theme(legend.position="none")
hist(obesity$Main_Meals)
summary(obesity$Main_Meals)

# check again for water, higher amount of water consumption, higher chance for obesity end
ggplot(data = obesity, aes(x=obesity_ordered, y=Water)) + 
  geom_boxplot(alpha=0.2)  +  theme(legend.position="none")

#
ggplot(data = obesity, aes(x=Age, y=Time_On_Technology_Devices)) + 
  geom_point(alpha=0.2) + geom_smooth(method = 'lm')  +  theme(legend.position="none")
```

```{r categorical Varible, include = FALSE}
# Gender, females are more chance to have Normal_or_Underweight
table(obesity$obesity_ordered, obesity$Gender)
prop.table(table(obesity$obesity_ordered, obesity$Gender), 2)
chisq.test(table(obesity$obesity_ordered, obesity$Gender))

# People with family_history of obesity are more likely to get obesity
table(obesity$obesity_ordered, obesity$Family_History)
prop.table(table(obesity$obesity_ordered, obesity$Family_History), 2)
chisq.test(table(obesity$obesity_ordered, obesity$Family_History))

# Only few observations without high caloric food consumption
# yes means more towards obesity end
table(obesity$obesity_ordered, obesity$High_Caloric_Food)
prop.table(table(obesity$obesity_ordered, obesity$High_Caloric_Food), 2)
chisq.test(table(obesity$obesity_ordered, obesity$High_Caloric_Food))

# few observations without between meal consumption, not significant trend
table(obesity$obesity_ordered, obesity$Between_Meals)
prop.table(table(obesity$obesity_ordered, obesity$Between_Meals), 2)
chisq.test(table(obesity$obesity_ordered, obesity$Between_Meals))

# No significant trend
table(obesity$obesity_ordered, obesity$SMOKE)
prop.table(table(obesity$obesity_ordered, obesity$SMOKE), 2)
chisq.test(table(obesity$obesity_ordered, obesity$SMOKE))

# people with caloric monitoring habit has much lower chance for obesity
table(obesity$obesity_ordered, obesity$Monitoring)
prop.table(table(obesity$obesity_ordered, obesity$Monitoring), 2)
chisq.test(table(obesity$obesity_ordered, obesity$Monitoring))

# 
table(obesity$obesity_ordered, obesity$Alcohol)
prop.table(table(obesity$obesity_ordered, obesity$Alcohol), 2)
chisq.test(table(obesity$obesity_ordered, obesity$Alcohol))

# 
table(obesity$obesity_ordered, obesity$Transportation)
prop.table(table(obesity$obesity_ordered, obesity$Transportation), 2)
chisq.test(table(obesity$obesity_ordered, obesity$Transportation))
```

```{r, include = FALSE}
# Male with alcohol drinking habit has the same probability to have the extreme obesity end
# while alcohol consumption has a huge influence on female

prop.table(table(men$obesity_ordered, men$Alcohol), 2)
prop.table(table(female$obesity_ordered, female$Alcohol), 2)
```

```{r, include = FALSE}
# Interaction with Gender

# no change in association
ggplot(obesity,aes(x=Age, y= obesity_ordered, fill=obesity_ordered)) + 
        geom_boxplot(alpha=0.2)  +  theme(legend.position="none") +
        facet_wrap( ~ Gender)

# Female are more easlily influenced by family history
prop.table(table(men$obesity_ordered, men$Family_History), 2)
prop.table(table(female$obesity_ordered, female$Family_History), 2)

```

# Model Selection
```{r, include = FALSE}
model_full = polr(obesity_ordered ~ Gender + Age + Family_History + High_Caloric_Food + Main_Meals + Between_Meals + SMOKE + Monitoring + Physical_Activity + Time_On_Technology_Devices + Alcohol + Transportation, data = obesity)
AIC(model_full)
coef(model_full) 
confint(model_full) # Between_Meals, Smoke, Monitor not significant

# Delete Smoke, smoke is not a significant predictor
model1 = polr(obesity_ordered ~ Gender + Age + Family_History + High_Caloric_Food + Main_Meals + Between_Meals + Monitoring + Physical_Activity + Time_On_Technology_Devices + Alcohol + Transportation, data = obesity)
anova(model_full,model1)

# Delete Monitor, Monitor is not a significant predictor
model2 = polr(obesity_ordered ~ Gender + Age + Family_History + High_Caloric_Food + Main_Meals + Between_Meals + Physical_Activity + Time_On_Technology_Devices + Alcohol + Transportation, data = obesity)
anova(model1,model2)

# Delete between_meals, between_meals is not a significant predictor
model3 = polr(obesity_ordered ~ Gender + Age + Family_History + High_Caloric_Food + Main_Meals + Physical_Activity + Time_On_Technology_Devices + Alcohol + Transportation, data = obesity)
anova(model2,model3)

# Interaction with Gender and Family History
model4 = polr(obesity_ordered ~ Gender * Family_History + Age + High_Caloric_Food + Main_Meals + Physical_Activity + Time_On_Technology_Devices + Alcohol + Transportation, data = obesity)
confint(model4)
AIC(model4)
anova(model4, model3)

# Interaction with Gender and Alcohol
model5 = polr(obesity_ordered ~ Gender * (Family_History + Alcohol) + Age + High_Caloric_Food + Main_Meals + Physical_Activity + Time_On_Technology_Devices + Transportation, data = obesity)
confint(model5)
AIC(model5)
anova(model4, model5)

model6 = polr(obesity_ordered ~ Gender + Age + Family_History + High_Caloric_Food + Main_Meals + Physical_Activity  + Alcohol + Transportation, data = obesity)
anova(model6,model4)
```
# Model Interpretation and Conclusion

```{r, echo = FALSE, include = FALSE}
final_model = polr(obesity_ordered ~ Gender * (Family_History + Alcohol) + Age + High_Caloric_Food + Main_Meals + Physical_Activity + Time_On_Technology_Devices + Transportation, data = obesity)
summary(final_model)
confint(final_model)
```

# Model Accessment

```{r echo = FALSE, include=FALSE, out.width='75%', message=FALSE}

# Residual and binplot
predprobs <- fitted(final_model) 

rawresid1 <- (obesity$obesity_ordered == "Normal_or_Underweight") -  predprobs[,1]
rawresid2 <- (obesity$obesity_ordered == "Overweight") -  predprobs[,2]
rawresid3 <- (obesity$obesity_ordered == "Obesity") -  predprobs[,3] 

```

 
```{r  include=FALSE}

# residual for main_meal
binnedplot(obesity$Main_Meals, rawresid1, xlab = "Fixed acidity", ylab = "Raw residuals", main = "Binned plot: calss = Normal_or_Underweight ", col.pts = "blue")
binnedplot(obesity$Main_Meals, rawresid2, xlab = "Fixed acidity", ylab = "Raw residuals", main = "Binned plot: calss = Overweight ", col.pts = "blue")
binnedplot(obesity$Main_Meals, rawresid3, xlab = "Fixed acidity", ylab = "Raw residuals", main = "Binned plot: calss = Obesity ", col.pts = "blue")

# residual for age
binnedplot(obesity$Age, rawresid1, xlab = "Fixed acidity", ylab = "Raw residuals", main = "Binned plot: calss = Normal_or_Underweight ", col.pts = "blue")
binnedplot(obesity$Age, rawresid2, xlab = "Fixed acidity", ylab = "Raw residuals", main = "Binned plot: calss = Overweight ", col.pts = "blue")
binnedplot(obesity$Age, rawresid3, xlab = "Fixed acidity", ylab = "Raw residuals", main = "Binned plot: calss = Obesity ", col.pts = "blue")
```


```{r, include = FALSE}
pred <- predict(model5)
Conf_mat <- confusionMatrix(as.factor(pred),as.factor(obesity$obesity_ordered))
Conf_mat$table
Conf_mat$overall["Accuracy"]
Conf_mat$byClass[,c("Sensitivity", "Specificity")]
```

# Limitation

This analysis of the dataset collected by a 2018 study for obesity level estimation using habits and physical conditions provides some evidence-based conclusion on the impact of age, alcohol consumption, intake of high caloric food, and family obesity history as significant risk factors in obesity development. The proportional odds model also analyzes the quantified effect of longer physical exercise time and green transportation method on controlling weight. However, limitations could occur during the analysis. Primarily, the dataset used for analysis is based on anonymous and volunteer survey results. Therefore, skewed response and volunteer-based bias can exist, especially for demographic and behavior related questions such as weight and alcohol consumption. Moreover, the cause of obesity is complex and usually requires a combination of various risk factors. The statistical analysis is conducted without controlling factors related to mental health, economic conditions, and social environment. Further discussions and observations of those missing elements should provide a clear picture of the impact of eating habits and physical conditions on obesity levels.

# Reference
[1]De-La-Hoz-Correa, E., Mendoza Palechor, F., De-La-Hoz-Manotas, A., Morales Ortega, R., &
SÃ¡nchez HernÃ¡ndez, A. B. (2019). Obesity level estimation software based on decision trees.

[2]Palechor, F. M., & de la Hoz Manotas, A. (2019). Dataset for estimation of obesity levels based on
eating habits and physical condition in individuals from Colombia, Peru and Mexico. Data in Brief,
104344.

[3]Kuźbicka K, Rachoń D. Bad eating habits as the main cause of obesity among children. Pediatr Endocrinol Diabetes Metab. 2013;19(3):106-10. PMID: 25577898.


# Appendix
```{r ref.label=knitr::all_labels(), echo = T, eval = F}
```




